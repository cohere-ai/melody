# This file is based on an autogenerated file by maturin v1.9.6
#    maturin generate-ci github --pytest
# It is edited afterwards
name: python CI

on:
  push:
    branches: [main]
  pull_request: {}
  merge_group: {}

permissions:
  contents: read

jobs:
  py-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: pytest
        shell: bash
        run: |
          set -e
          python3 -m venv .venv
          source .venv/bin/activate
          pip install cohere_melody --find-links dist --force-reinstall
          pip install pytest
          pytest

  formatting:
    runs-on: depot-ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - uses: psf/black@stable

  type-check:
    runs-on: depot-ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
      - name: Build sdist
        uses: PyO3/maturin-action@v1
        with:
          command: sdist
          args: --out dist
      - name: ty
        shell: bash
        run: |
          set -e
          python3 -m venv .venv
          source .venv/bin/activate
          pip install ty vllm
          pip install cohere_melody --find-links dist --force-reinstall
          ty check python/
