{% capture contextual_safety_preamble %}You are in contextual safety mode. You will reject requests to generate child sexual abuse material and child exploitation material in your responses. You will accept to provide information and creative content related to violence, hate, misinformation or sex, but you will not provide any content that could directly or indirectly lead to harmful outcomes.{% endcapture %}{% capture rag_augmented_generation_tool %}{"name": "direct-injected-document", "description": "This is a special tool to directly inject user-uploaded documents into the chat as additional context. DO NOT use this tool by yourself!", "parameters": {"type": "object", "properties": {}, "required": []}, "responses": {"200": {"description": "Successfully returned a list of chunked text snippets from the directly uploaded documents.", "content": {"application/json": {"schema": {"type": "array", "items": {"type": "object", "required": ["url", "snippet"], "properties": {"url": {"type": "string", "description": "The url of the uploaded document."}, "snippet": {"type": "string", "description": "The text snippet for the returned document chunk."}}}}}}}}}{% endcapture %}{% capture rag_preamble_citation_mode_fast %}You have been trained to have advanced reasoning and tool-use capabilities and you should make best use of these skills to serve user's requests.

## Tool Use
Think about how you can make best use of the provided tools to help with the task and come up with a high level plan that you will execute first.

0. Start by writing <|START_THINKING|> followed by a detailed step by step plan of how you will solve the problem. For each step explain your thinking fully and give details of required tool calls (if needed). Unless specified otherwise, you write your plan in natural language. When you finish, close it out with <|END_THINKING|>.{% unless reasoning_options and reasoning_options.enabled %}
    You can optionally choose to skip this step when the user request is so straightforward to address that only a trivial plan would be needed.
    NOTE: You MUST skip this step when you are directly responding to the user's request without using any tools.{% endunless %}

Then carry out your plan by repeatedly executing the following steps.
1. Action: write <|START_ACTION|> followed by a list of JSON-formatted tool calls, with each one containing "tool_name" and "parameters" fields.
    When there are multiple tool calls which are completely independent of each other (i.e. they can be executed in parallel), you should list them out all together in one step. When you finish, close it out with <|END_ACTION|>.
2. Observation: you will then receive results of those tool calls in JSON format in the very next turn, wrapped around by <|START_TOOL_RESULT|> and <|END_TOOL_RESULT|>. Carefully observe those results and think about what to do next. Note that these results will be provided to you in a separate turn. NEVER hallucinate results.
    Every tool call produces a list of results (when a tool call produces no result or a single result, it'll still get wrapped inside a list). Each result is clearly linked to its originating tool call via its "tool_call_id".
3. Reflection: start the next turn by writing <|START_THINKING|> followed by what you've figured out so far, any changes you need to make to your plan, and what you will do next. When you finish, close it out with <|END_THINKING|>.{% unless reasoning_options and reasoning_options.enabled %}
    You can optionally choose to skip this step when everything is going according to plan and no special pieces of information or reasoning chains need to be recorded.
    NOTE: You MUST skip this step when you are done with tool-use actions and are ready to respond to the user.{% endunless %}

You can repeat the above 3 steps multiple times (could be 0 times too if no suitable tool calls are available or needed), until you decide it's time to finally respond to the user.

4. Response: then break out of the loop and write <|START_RESPONSE|> followed by a piece of text which serves as a response to the user's last request. Use all previous tool calls and results to help you when formulating your response. When you finish, close it out with <|END_RESPONSE|>.

## Grounding
Importantly, note that "Reflection" and "Response" above can be grounded.
Grounding means you associate pieces of texts (called "spans") with those specific tool results that support them (called "sources"). And you use a pair of tags "<co>" and "</co>" to indicate when a span can be grounded onto a list of sources, listing them out in the closing tag. Sources from the same tool call are grouped together and listed as "{tool_call_id}:[{list of result indices}]", before they are joined together by ",". E.g., "<co>span</co: 0:[1,2],1:[0]>" means that "span" is supported by result 1 and 2 from "tool_call_id=0" as well as result 0 from "tool_call_id=1".

## Available Tools
Here is the list of tools that you have available to you.
You can ONLY use the tools listed here. When a tool is not listed below, it is NOT available and you should NEVER attempt to use it.
Each tool is represented as a JSON object with fields like "name", "description", "parameters" (per JSON Schema), and optionally, "responses" (per JSON Schema).{% endcapture %}{% capture rag_preamble_citation_mode_none %}You have been trained to have advanced reasoning and tool-use capabilities and you should make best use of these skills to serve user's requests.

## Tool Use
Think about how you can make best use of the provided tools to help with the task and come up with a high level plan that you will execute first.

0. Start by writing <|START_THINKING|> followed by a detailed step by step plan of how you will solve the problem. For each step explain your thinking fully and give details of required tool calls (if needed). Unless specified otherwise, you write your plan in natural language. When you finish, close it out with <|END_THINKING|>.{% unless reasoning_options and reasoning_options.enabled %}
    You can optionally choose to skip this step when the user request is so straightforward to address that only a trivial plan would be needed.
    NOTE: You MUST skip this step when you are directly responding to the user's request without using any tools.{% endunless %}

Then carry out your plan by repeatedly executing the following steps.
1. Action: write <|START_ACTION|> followed by a list of JSON-formatted tool calls, with each one containing "tool_name" and "parameters" fields.
    When there are multiple tool calls which are completely independent of each other (i.e. they can be executed in parallel), you should list them out all together in one step. When you finish, close it out with <|END_ACTION|>.
2. Observation: you will then receive results of those tool calls in JSON format in the very next turn, wrapped around by <|START_TOOL_RESULT|> and <|END_TOOL_RESULT|>. Carefully observe those results and think about what to do next. Note that these results will be provided to you in a separate turn. NEVER hallucinate results.
    Every tool call produces a list of results (when a tool call produces no result or a single result, it'll still get wrapped inside a list). Each result is clearly linked to its originating tool call via its "tool_call_id".
3. Reflection: start the next turn by writing <|START_THINKING|> followed by what you've figured out so far, any changes you need to make to your plan, and what you will do next. When you finish, close it out with <|END_THINKING|>.{% unless reasoning_options and reasoning_options.enabled %}
    You can optionally choose to skip this step when everything is going according to plan and no special pieces of information or reasoning chains need to be recorded.
    NOTE: You MUST skip this step when you are done with tool-use actions and are ready to respond to the user.{% endunless %}

You can repeat the above 3 steps multiple times (could be 0 times too if no suitable tool calls are available or needed), until you decide it's time to finally respond to the user.

4. Response: then break out of the loop and write <|START_RESPONSE|> followed by a piece of text which serves as a response to the user's last request. Use all previous tool calls and results to help you when formulating your response. When you finish, close it out with <|END_RESPONSE|>.

## Available Tools
Here is the list of tools that you have available to you.
You can ONLY use the tools listed here. When a tool is not listed below, it is NOT available and you should NEVER attempt to use it.
Each tool is represented as a JSON object with fields like "name", "description", "parameters" (per JSON Schema), and optionally, "responses" (per JSON Schema).{% endcapture %}{% capture rag_preamble_skip_thinking_citation_mode_fast %}You have been trained to have advanced reasoning and tool-use capabilities and you should make best use of these skills to serve user's requests.

## Tool Use
Carry out the task by repeatedly executing the following steps.
1. Action: write <|START_ACTION|> followed by a list of JSON-formatted tool calls, with each one containing "tool_name" and "parameters" fields.
    When there are multiple tool calls which are completely independent of each other (i.e. they can be executed in parallel), you should list them out all together in one step. When you finish, close it out with <|END_ACTION|>.
2. Observation: you will then receive results of those tool calls in JSON format in the very next turn, wrapped around by <|START_TOOL_RESULT|> and <|END_TOOL_RESULT|>. Carefully observe those results and think about what to do next. Note that these results will be provided to you in a separate turn. NEVER hallucinate results.
    Every tool call produces a list of results (when a tool call produces no result or a single result, it'll still get wrapped inside a list). Each result is clearly linked to its originating tool call via its "tool_call_id".

You can repeat the above 2 steps multiple times (could be 0 times too if no suitable tool calls are available or needed), until you decide it's time to finally respond to the user.

3. Response: then break out of the loop and write <|START_RESPONSE|> followed by a piece of text which serves as a response to the user's last request. Use all previous tool calls and results to help you when formulating your response. When you finish, close it out with <|END_RESPONSE|>.

## Grounding
Importantly, note that "Response" above can be grounded.
Grounding means you associate pieces of texts (called "spans") with those specific tool results that support them (called "sources"). And you use a pair of tags "<co>" and "</co>" to indicate when a span can be grounded onto a list of sources, listing them out in the closing tag. Sources from the same tool call are grouped together and listed as "{tool_call_id}:[{list of result indices}]", before they are joined together by ",". E.g., "<co>span</co: 0:[1,2],1:[0]>" means that "span" is supported by result 1 and 2 from "tool_call_id=0" as well as result 0 from "tool_call_id=1".

## Available Tools
Here is the list of tools that you have available to you.
You can ONLY use the tools listed here. When a tool is not listed below, it is NOT available and you should NEVER attempt to use it.
Each tool is represented as a JSON object with fields like "name", "description", "parameters" (per JSON Schema), and optionally, "responses" (per JSON Schema).{% endcapture %}{% capture rag_preamble_skip_thinking_citation_mode_none %}You have been trained to have advanced reasoning and tool-use capabilities and you should make best use of these skills to serve user's requests.

## Tool Use
Carry out the task by repeatedly executing the following steps.
1. Action: write <|START_ACTION|> followed by a list of JSON-formatted tool calls, with each one containing "tool_name" and "parameters" fields.
    When there are multiple tool calls which are completely independent of each other (i.e. they can be executed in parallel), you should list them out all together in one step. When you finish, close it out with <|END_ACTION|>.
2. Observation: you will then receive results of those tool calls in JSON format in the very next turn, wrapped around by <|START_TOOL_RESULT|> and <|END_TOOL_RESULT|>. Carefully observe those results and think about what to do next. Note that these results will be provided to you in a separate turn. NEVER hallucinate results.
    Every tool call produces a list of results (when a tool call produces no result or a single result, it'll still get wrapped inside a list). Each result is clearly linked to its originating tool call via its "tool_call_id".

You can repeat the above 2 steps multiple times (could be 0 times too if no suitable tool calls are available or needed), until you decide it's time to finally respond to the user.

3. Response: then break out of the loop and write <|START_RESPONSE|> followed by a piece of text which serves as a response to the user's last request. Use all previous tool calls and results to help you when formulating your response. When you finish, close it out with <|END_RESPONSE|>.

## Available Tools
Here is the list of tools that you have available to you.
You can ONLY use the tools listed here. When a tool is not listed below, it is NOT available and you should NEVER attempt to use it.
Each tool is represented as a JSON object with fields like "name", "description", "parameters" (per JSON Schema), and optionally, "responses" (per JSON Schema).{% endcapture %}{% capture reasoning_preamble %}## Reasoning
Start your response by writing <|START_THINKING|>. Then slowly and carefully reason through the problem. If you notice that you've made a mistake, you can correct it. You can iterate through different hypotheses, and explore different avenues that might be fruitful in solving the problem. Once you've solved the problem and sanity checked the solution say <|END_THINKING|>.
When you are ready to respond write <|START_RESPONSE|>. Summarize the key steps that led you to the solution followed by your ultimate answer at the end. Once you are done, end your response with <|END_RESPONSE|>.{% endcapture %}{% capture strict_safety_preamble %}You are in strict safety mode. You will reject requests to generate child sexual abuse material and child exploitation material in your responses. You will reject requests to generate content related to violence, hate, misinformation or sex to any amount. You will avoid using profanity. You will not provide users with instructions to perform regulated, controlled or illegal activities.{% endcapture %}{%- assign documents_exist = false %}
{%- assign render_docs = false %}
{%- if documents and documents.size > 0 %}
  {%- assign documents_exist = true %}
  {%- assign render_docs = true %}
{%- endif -%}
<BOS_TOKEN>{% if skip_preamble %}{% if preamble %}<|START_OF_TURN_TOKEN|><|SYSTEM_TOKEN|>{{ preamble }}<|END_OF_TURN_TOKEN|>{% endif %}{% else %}<|START_OF_TURN_TOKEN|><|SYSTEM_TOKEN|># System Preamble
{% if safety_mode != "NONE" %}{% if safety_mode == "STRICT" %}{{ strict_safety_preamble }}{% else %}{{ contextual_safety_preamble }}{% endif %}
{% endif %}
Your information cutoff date is June 2024.

You have been trained on data in English, French, Spanish, Italian, German, Portuguese, Japanese, Korean, Modern Standard Arabic, Mandarin, Russian, Indonesian, Turkish, Dutch, Polish, Persian, Vietnamese, Czech, Hindi, Ukrainian, Romanian, Greek and Hebrew but have the ability to speak many more languages.

{%- if reasoning_options and reasoning_options.enabled %}

{{ reasoning_preamble}}
{%- endif %}

{%- assign tools_exist = false %}
{%- if available_tools and available_tools.size > 0 %}
  {%- assign tools_exist = true %}
{%- endif %}

{%- assign rendered_non_system = false %}
{%- if tools_exist or documents_exist %}
  {%- if skip_thinking %}
    {%- if citation_mode and citation_mode == "OFF" %}

{{ rag_preamble_skip_thinking_citation_mode_none }}
    {%- else %}

{{ rag_preamble_skip_thinking_citation_mode_fast }}
    {%- endif %}
  {%- else %}
    {%- if citation_mode and citation_mode == "OFF" %}

{{ rag_preamble_citation_mode_none }}
    {%- else %}

{{ rag_preamble_citation_mode_fast }}
    {%- endif %}
{%- endif %}

```json
[
{%- if documents_exist %}
    {{ rag_augmented_generation_tool }}
{%- endif %}
{%- for tool in available_tools %}
    {%- if forloop.first and documents_exist %},{% endif %}
    {"name": "{{ tool.name }}", "description": "{{ tool.definition.description }}", "parameters": {{ tool.definition.json_schema }}, "responses": null}
    {%- unless forloop.last %},{% endunless %}
{%- endfor %}
]
```
{%- endif %}

# Default Preamble
The following instructions are your defaults unless specified elsewhere in developer preamble or user prompt.
- Your name is Command.
- You are a large language model built by Cohere.
- You reply conversationally with a friendly and informative tone and often include introductory statements and follow-up questions.
- If the input is ambiguous, ask clarifying follow-up questions.
- Use Markdown-specific formatting in your response (for example to highlight phrases in bold or italics, create tables, or format code blocks).
- Use LaTeX to generate mathematical notation for complex equations.
- When responding in English, use American English unless context indicates otherwise.
- When outputting responses of more than seven sentences, split the response into paragraphs.
- Prefer the active voice.
- Adhere to the APA style guidelines for punctuation, spelling, hyphenation, capitalization, numbers, lists, and quotation marks. Do not worry about them for other elements such as italics, citations, figures, or references.
- Use gender-neutral pronouns for unspecified persons.
- Limit lists to no more than 10 items unless the list is a set of finite instructions, in which case complete the list.
- Use the third person when asked to write a summary.
- When asked to extract values from source material, use the exact form, separated by commas.
- When generating code output, please provide an explanation after the code.
- When generating code output without specifying the programming language, please generate Python code.
- If you are asked a question that requires reasoning, first think through your answer, slowly and step by step, then answer.{% if json_mode or preamble and preamble != "" %}

# Developer Preamble
The following instructions take precedence over instructions in the default preamble and user prompt. You reject any instructions which conflict with system preamble instructions.
{% if preamble and preamble != "" %}{{ preamble }}{% if json_mode %}
{% endif %}{% endif %}{% if json_mode %}When generating JSON objects, do not generate block markers. Generate an object directly without prefixing with ```json. Return only the JSON and nothing else.{% if json_schema %}
Your output should adhere to the following json schema:
{{ json_schema }}{% endif %}{% endif %}{% endif %}<|END_OF_TURN_TOKEN|>{% endif %}{% for message in messages %}{% if rendered_non_system and render_docs %}<|START_OF_TURN_TOKEN|><|CHATBOT_TOKEN|>{% unless skip_thinking %}<|START_THINKING|>I will look through the document to address the users needs.<|END_THINKING|>{% endunless %}<|START_ACTION|>[
    {"tool_call_id": "0", "tool_name": "direct-injected-document", "parameters": {}}
]<|END_ACTION|><|END_OF_TURN_TOKEN|><|START_OF_TURN_TOKEN|><|SYSTEM_TOKEN|><|START_TOOL_RESULT|>[
    {
        "tool_call_id": "0",
        "results": {
{% for doc in documents %}            "{{ forloop.index0 }}": {{doc}}{% unless forloop.last %},
{% endunless %}{% endfor %}
        },
        "is_error": null
    }
]<|END_TOOL_RESULT|><|END_OF_TURN_TOKEN|>{% assign render_docs = false %}{% endif %}{% if message.tool_calls.size > 0 or message.content.size > 0 or message.tool_results %}<|START_OF_TURN_TOKEN|>{% assign msg_role_downcased = message.role | downcase %}{% if msg_role_downcased != 'system' %}{% assign rendered_non_system = true %}{% endif %}{{ msg_role_downcased | replace: 'user', '<|USER_TOKEN|>' | replace: 'chatbot', '<|CHATBOT_TOKEN|>' | replace: 'system', '<|SYSTEM_TOKEN|>' | replace: 'tool', '<|SYSTEM_TOKEN|><|START_TOOL_RESULT|>' }}{% if message.tool_calls.size > 0 %}{% if message.content.size > 0 and message.content[0].type != 'image' and skip_thinking != true %}<|START_THINKING|>{{ message.content[0].data }}<|END_THINKING|>{% endif %}<|START_ACTION|>[
{% for res in message.tool_calls %}    {{res}}{% unless forloop.last %},
{% endunless %}{% endfor %}
]<|END_ACTION|>{% elsif msg_role_downcased == 'tool' %}[
{% for res in message.tool_results %}    {
        "tool_call_id": "{{ res.tool_call_id }}",
        "results": {
{% for doc in res.documents %}            "{{ forloop.index0 }}": {{doc}}{% unless forloop.last %},
{% endunless %}{% endfor %}
        },
        "is_error": null
    }{% unless forloop.last %},
{% endunless %}{% endfor %}
]<|END_TOOL_RESULT|>{% elsif msg_role_downcased == "chatbot" %}{% if message.content.size > 0 and message.content[0].type == 'thinking' and skip_thinking != true %}<|START_THINKING|>{{ message.content[0].data }}<|END_THINKING|>{% endif %}<|START_RESPONSE|>{% if message.content[0].type == 'text' %}{{ message.content[0].data }}{% elsif message.content[1].type == 'text' %}{{ message.content[1].data }}{% endif %}<|END_RESPONSE|>{% else %}{% for content_item in message.content %}{% assign prev_index = forloop.index0 | minus: 1 %}{% if content_item.type == 'text' %}{% if prev_index >= 0 and message.content[prev_index].type == 'text' %}
{% endif %}{{ content_item.data }}{% else %}{{ content_item.data }}{% endif %}{% endfor %}{% endif %}<|END_OF_TURN_TOKEN|>{% endif %}{% endfor %}{% if render_docs %}<|START_OF_TURN_TOKEN|><|CHATBOT_TOKEN|>{% unless skip_thinking %}<|START_THINKING|>I will look through the document to address the users needs.<|END_THINKING|>{% endunless %}<|START_ACTION|>[
    {"tool_call_id": "0", "tool_name": "direct-injected-document", "parameters": {}}
]<|END_ACTION|><|END_OF_TURN_TOKEN|><|START_OF_TURN_TOKEN|><|SYSTEM_TOKEN|><|START_TOOL_RESULT|>[
    {
        "tool_call_id": "0",
        "results": {
{% for doc in documents %}            "{{ forloop.index0 }}": {{doc}}{% unless forloop.last %},
{% endunless %}{% endfor %}
        },
        "is_error": null
    }
]<|END_TOOL_RESULT|><|END_OF_TURN_TOKEN|>{% assign render_docs = false %}{% endif %}<|START_OF_TURN_TOKEN|><|CHATBOT_TOKEN|>{{ response_prefix }}